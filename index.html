
<html>
<head>
    <title>Number Theory Visualizer: Rational Angles & Coprime Density</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            margin: 0;
            background-color: #fafafa;
        }
        #controls { 
            width: 320px; 
            padding: 20px; 
            background: #ffffff; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        #visualization { 
            flex-grow: 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
        }
        canvas { 
            display: block; 
            border: 1px solid #e0e0e0; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        h2, h3 { 
            color: #333; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 5px; 
            margin-top: 20px;
        }
        .control-group { 
            margin-bottom: 20px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            background-color: #f9f9f9;
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600;
        }
        input[type=range] { 
            width: 100%; 
            margin-bottom: 10px;
        }
        button { 
            padding: 10px 18px; 
            margin-right: 10px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { 
            background-color: #0056b3; 
        }
        #propFarey, #propCoprime { font-size: 1.1em; color: #d9534f; }
    </style>
</head>
<body>

    <div id="controls">
        <h2>ðŸ”¢ Visualizer Controls</h2>

        <div class="control-group">
            <label for="limitQ">Limit $\mathbf{Q}$ (Max Denominator):</label>
            <input type="range" id="limitQ" min="2" max="150" value="15" step="1" oninput="updateVisualization()">
            <span id="limitQValue" style="font-weight: bold;">15</span>
            <p style="font-size: 0.9em; margin-top: 5px;">Visualizes all points $e^{2\pi i a/q}$ with $q \le Q$ and $\gcd(a, q)=1$.</p>
        </div>

        <div class="control-group">
            <label for="colorScheme">Coloring Scheme:</label>
            <select id="colorScheme" onchange="updateVisualization()">
                <option value="none">None (Black)</option>
                <option value="denominator">By Denominator (q)</option>
                <option value="gcd">By $\gcd(a, q)$ - *Fixed to 1*</option>
            </select>
        </div>
        
        <div class="control-group">
            <h3>Calculated Properties (Q=<span id="propQ" style="color: #337ab7;"></span>)</h3>
            <p>|F_Q| (Farey Sequence Count): <strong id="propFarey"></strong></p>
            <p>Coprime Pairs $B_Q$ ($\mathbf{1 \le a \le q \le Q}$): <strong id="propReducedCoprime"></strong></p>
            <p>Asymptotic Constant $\approx \mathbf{3/\pi^2} \approx 0.304$</p>
            <p>Ratio $|F_Q|/Q^2$: <strong id="propRatio"></strong></p>
        </div>

        <div class="control-group">
            <h3>ðŸ’¾ Export</h3>
            <button onclick="exportPNG()">Export PNG</button>
            <button onclick="exportCSV()">Export Data (CSV)</button>
        </div>
    </div>
    
    <div id="visualization">
        </div>

    <script>
        // --- Core Mathematical Functions ---
        function gcd(a, b) {
            while (b) {
                [a, b] = [b, a % b];
            }
            return a;
        }

        function phi(n) {
            let result = n;
            for (let i = 2; i * i <= n; i++) {
                if (n % i === 0) {
                    while (n % i === 0)
                        n /= i;
                    result -= result / i;
                }
            }
            if (n > 1)
                result -= result / n;
            return result;
        }

        function getReducedFractions(Q) {
            let fractions = [];
            let reducedCoprimeCount = 0; // B_Q = #{(a,q): 1<=a<=q<=Q, gcd(a,q)=1}
            let FareyCount = 1; // Start with 0/1
            
            for (let q = 1; q <= Q; q++) {
                // Total reduced fractions in (0, 1] is phi(q)
                FareyCount += phi(q);
                
                for (let a = 1; a < q; a++) { 
                    if (gcd(a, q) === 1) {
                        fractions.push({ a: a, q: q, value: a / q });
                        reducedCoprimeCount++;
                    }
                }
                // Include 0/q and q/q if q=1 (0/1, 1/1)
                if (q === 1) {
                    fractions.push({ a: 0, q: 1, value: 0 }); // 0/1
                    fractions.push({ a: 1, q: 1, value: 1 }); // 1/1
                    reducedCoprimeCount++; // Include 1/1 in the B_Q count (for 1<=a<=q)
                }
            }
            
            return { points: fractions, B_Q: reducedCoprimeCount, FareyCount: FareyCount }; 
        }

        // --- p5.js Setup and Drawing ---
        let canvasSize = 600;
        let Q_current = 15;
        let colorScheme_current = 'denominator';

        function setup() {
            let canvas = createCanvas(canvasSize, canvasSize);
            canvas.parent('visualization');
            colorMode(HSB, 360, 100, 100);
            noLoop(); 
            window.sketch = this;
            updateVisualization(); 
        }

        function draw() {
            // draw() is not used directly since we use noLoop() and call drawVisualization() manually
        }
        
        function updateVisualization() {
            Q_current = parseInt(document.getElementById('limitQ').value);
            document.getElementById('limitQValue').textContent = Q_current;
            document.getElementById('propQ').textContent = Q_current;
            colorScheme_current = document.getElementById('colorScheme').value;

            redrawVisualization();
        }

        function redrawVisualization() {
            background(255);
            translate(width / 2, height / 2);
            let radius = width * 0.45;
            
            // 1. Draw the Unit Circle
            noFill();
            stroke(0, 50);
            strokeWeight(1);
            ellipse(0, 0, radius * 2);

            // 2. Get the points
            let data = getReducedFractions(Q_current);
            
            // 3. Plot the points
            let pointCount = data.points.length;
            let pointDiameter = map(Q_current, 2, 150, 6, 2);
            
            for (let pointData of data.points) {
                let angle = -2 * Math.PI * pointData.value; // Angle from positive X-axis (standard complex plane direction)
                let x = radius * cos(angle);
                let y = radius * sin(angle);
                
                let pointColor = color(0); // Default black
                
                if (colorScheme_current === 'denominator') {
                    // Color based on denominator (q)
                    let hue = map(pointData.q, 1, Q_current, 0, 300); 
                    pointColor = color(hue, 80, 80);
                }
                
                stroke(pointColor);
                fill(pointColor);
                strokeWeight(1);
                ellipse(x, y, pointDiameter, pointDiameter);
            }
            
            // 4. Update Properties Display
            document.getElementById('propFarey').textContent = data.FareyCount;
            document.getElementById('propReducedCoprime').textContent = data.B_Q;
            document.getElementById('propRatio').textContent = (data.FareyCount / (Q_current * Q_current)).toFixed(5);
        }

        // --- Export Functions ---
        function exportPNG() {
            saveCanvas('Unit_Circle_Q' + Q_current + '.png', 'png');
        }

        function exportCSV() {
            let data = getReducedFractions(Q_current);
            let csvContent = "Denominator (q),Numerator (a),Fractional_Value (a/q),Angle_Radians,X_Coordinate,Y_Coordinate\n";
            const PI = 3.141592653589793;
            
            for (let pointData of data.points) {
                let angle = 2 * PI * pointData.value;
                let x = Math.cos(angle);
                let y = Math.sin(angle);
                csvContent += `${pointData.q},${pointData.a},${pointData.value.toFixed(6)},${angle.toFixed(6)},${x.toFixed(6)},${y.toFixed(6)}\n`;
            }

            let encodedUri = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Farey_points_data_Q" + Q_current + ".csv");
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>

